---
applyTo: "apps/backend/**"
---
# GitHub Copilot Instructions（バックエンド）

## 言語設定

- すべてのレビューコメントとフィードバックは**日本語**で記述してください
- コードコメントの提案も日本語で行ってください
- 技術用語は適切に日本語化し、必要に応じて英語表記を併記してください

## Pull Request 作成時の言語

- copilot-agent によって pull request を生成する場合、タイトル・説明・変更点・テスト結果などすべて日本語で記述してください。
- 体裁は普通のチーム向け PR と同じにして、要点がすぐに分かる構成（目的/変更/テスト/注意点）にして、英語を使う場面があれば括弧付きで補足してください。

## レビュー方針

### コード品質

- TypeScript/JavaScript のベストプラクティスに従っているか確認
- 型安全性が確保されているか確認
- エラーハンドリングが適切に実装されているか確認
- 未使用の変数やインポートがないか確認

### パフォーマンス

- 非効率なループや処理がないか
- メモリリークの可能性がないか

### セキュリティ

- 機密情報のハードコーディングがないか
- SQL インジェクションや XSS の脆弱性がないか
- 適切な認証・認可が実装されているか

### テスト

- 新機能に対するテストケースが追加されているか
- エッジケースのテストが含まれているか
- テストカバレッジが適切か

#### テスト記述ルール

- Vitest の `describe` / `it` の説明文は日本語で記述する（例: "〜できる", "〜の場合は例外になる"）
- テストは原則として `describe("正常系")` / `describe("異常系")` を挟み、意図が分かるように分類する
- テスト内の一時変数の初期値として `null` は使用しない（未設定は `undefined` を使う）。※ 型/仕様として `null` が必須な入出力（例: DBの nullable 列、DTO）を除く

### ドキュメント

- 複雑なロジックにコメントが付いているか
- 公開 API やコンポーネントにドキュメントがあるか
- README の更新が必要な場合は指摘

## プロジェクト固有のルール（バックエンド）

### 対象

- `apps/backend`: Hono + TypeScript

### コーディング規約

- Biome を使用した Lint と Format
- Vitest を使用したテスト
- Turborepo を使用したビルド管理

### オニオンアーキテクチャ ガードレール

- 依存方向は常に内側（ドメイン）に向ける
- ドメイン層はフレームワークや DB へ依存しない
- アプリケーション層はドメイン層のみに依存する
- インターフェース層は入力/出力の変換のみを担当し、ドメインロジックは持たない
- インフラ層は外部依存の実装に限定し、ユースケースの判断を持たない
- DTO とドメインエンティティは分離する（ORM 型をドメインに漏らさない）
- 例外/エラーはドメイン → ユースケース → インターフェースの順で整形する
- 詳細は [docs/onion-architecture.md](docs/onion-architecture.md) に準拠する

### 追加ルール

- 原則として `for` / `for...of` / `for...in` は使用しない（コレクション操作や `reduce` などで表現する）
- 原則として `unknown` を型注釈として使用しない（必要ならジェネリクス + 型ガードで吸収する）
- 原則として `any` は使用しない（テスト/実装ともに型注釈・型アサーションで禁止）。代替: 適切な型定義・ジェネリクス・型ガード・`satisfies`・（テストの不正値注入は）より狭い union への型アサーションを使う
- マジックナンバー（例: 文字数制限、ページサイズ、桁数など）は直書きせず、定数として切り出して命名する
- メソッド内で直接 `if` を連打しない（原則として `if` は1回まで）。複数の条件分岐/バリデーションはガード関数・検証関数へ切り出す
- router（プレゼンテーション層）にバリデーションロジック（条件分岐やメッセージ判定）を書かない
- 入出力のバリデーションは `packages/shared` の Zod スキーマ（`.input(...)` / `.output(...)`）に責務を寄せる
- ビジネスロジックの失敗はユースケースで表現し、Result 型（Effect/TaggedError などの型付きエラー）として返す／throw する

### 命名規則

- コンポーネント: PascalCase（例: `UserProfile.tsx`）
- 関数・変数: camelCase（例: `getUserData`）
- 定数: UPPER_SNAKE_CASE（例: `MAX_RETRY_COUNT`）
- ファイル名: kebab-case または PascalCase（コンポーネントのみ）

## レビュー時の注意点

### 建設的なフィードバック

- 問題点を指摘するだけでなく、改善案も提示してください
- 重要度（Critical / Major / Minor）を明示してください
- 可能であればコード例を提示してください

### ポジティブなフィードバック

- 良い実装や改善点についても積極的にコメントしてください
- チームの学習と成長を促進するフィードバックを心がけてください

## 例外ケース

- WIP（Work In Progress）の PR には詳細なレビューは不要
- 自動生成されたファイル（`package-lock.json`など）は基本的にスキップ
- ドキュメントのみの変更は内容の正確性と分かりやすさを重視

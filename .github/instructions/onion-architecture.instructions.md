---
applyTo: "apps/backend/**"
---
# オニオンアーキテクチャのルール

## 目的

- ドメインの独立性を守り、変更に強い設計にする
- 依存方向を内側へ統一し、外部要因（HTTP/DB/フレームワーク）を隔離する
- テスト容易性を高める

## 層の定義

1. **ドメイン層（Domain）**
   - 事業ルールの中心。エンティティ、値オブジェクト、ドメインエラー、リポジトリのインターフェースを保持する
2. **アプリケーション層（Application / Use Case）**
   - ユースケース（業務手順）を実装する。ドメイン層のみへ依存する
3. **インターフェース層（Interface / Controller）**
   - HTTP、RPC、CLI などの入出力。ユースケースを呼び出して DTO へ変換する
4. **インフラ層（Infrastructure）**
   - DB、外部 API、フレームワーク実装。インターフェース層やアプリケーション層の定義に従う

## 依存関係ルール（必須）

- 依存は常に内側（ドメイン）へ向ける
- ドメイン層はフレームワークや DB へ依存しない
- アプリケーション層はドメイン層のみへ依存する
- インターフェース層とインフラ層は外側の詳細。内側の抽象に従う

## 責務と禁止事項

### ドメイン層

- **許可**: エンティティ、値オブジェクト、ドメインサービス、ドメインエラー、リポジトリのインターフェース
- **禁止**: HTTP、DB、フレームワーク、外部 SDK の型/関数への依存

### アプリケーション層

- **許可**: ユースケース、トランザクション制御、ドメインの組み合わせ
- **禁止**: リクエスト/レスポンスの直接利用、ORM モデル、HTTP 固有の例外

### インターフェース層

- **許可**: ルーティング、入力の受け取り、レスポンスの整形
- **禁止**: ドメインロジックの実装、永続化ロジック

### インフラ層

- **許可**: DB 実装、外部 API クライアント、フレームワークの DI/設定
- **禁止**: ドメインモデルの変更、ユースケースの分岐ロジック

## フォルダ構成の対応

- ドメイン層: `apps/backend/src/domain/**`
- アプリケーション層: `apps/backend/src/services/**`（ユースケース）
- インターフェース層: `apps/backend/src/controller/**`
- インフラ層: `apps/backend/src/infrastructre/**`

## DI（依存性注入）

- DI は InversifyJS を使用して実装する

## データの境界（DTO / エンティティ）

- ルーターの入力/出力は DTO として扱い、ドメインエンティティへ直接漏らさない
- インフラ層の ORM 型や DB レコードはドメインへ渡さない
- 変換はインターフェース層またはアプリケーション層の境界で行う

## エラー設計

- ドメインエラーは `domain` に閉じる
- ユースケース層は Result 型で失敗を表現する
- インターフェース層で HTTP ステータスへ変換する

## テスト方針

- ドメイン層はユニットテストを優先
- ユースケースはドメインをモックせずに検証し、インフラはモック/テストダブルで分離
- インフラ層のテストは統合テストで最小限にする
